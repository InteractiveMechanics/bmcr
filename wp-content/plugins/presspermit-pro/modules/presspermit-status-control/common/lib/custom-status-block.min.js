"use strict";

/**
 * ------------------------------------------------------------------------------
 * Based on Edit Flow
 * Author: Daniel Bachhuber, Scott Bressler, Mohammad Jangda, Automattic, and
 * others
 * Copyright (c) 2009-2019 Mohammad Jangda, Daniel Bachhuber, et al.
 * ------------------------------------------------------------------------------
 */
var __ = wp.i18n.__;
var PluginPostStatusInfo = wp.editPost.PluginPostStatusInfo;
var registerPlugin = wp.plugins.registerPlugin;
var _wp$data = wp.data,
    withSelect = _wp$data.withSelect,
    withDispatch = _wp$data.withDispatch;
var compose = wp.compose.compose;
var SelectControl = wp.components.SelectControl;
/**
 * Map Custom Statuses as options for SelectControl
 */

var statuses = window.PPCustomStatuses.statuses.map(function (s) {
  return {
    label: s.name,
    value: s.slug
  };
});

var getStatusLabel = function getStatusLabel(slug) {
  var item = statuses.find(function (s) {
    return s.value === slug;
  });

  if (item) {
    return item.label;
  }

  if (typeof privacyStatuses !== 'undefined') {
    item = privacyStatuses.find(function (s) {
      return s.value === slug;
    });

    if (item) {
      return item.label;
    }
  }

  return '';
}; // Remove the Published status from the list.


statuses = statuses.filter(function (item) {
  return item.value !== 'publish';
});

/**
 * Hack :(
 *
 * @see https://github.com/WordPress/gutenberg/issues/3144
 *
 * @param status
 */
var sideEffectL10nManipulation = function sideEffectL10nManipulation(status) {
  var statusLabel = getStatusLabel(status);

  if ('future' == status ) {
    return;
  }

  setTimeout(function () {
    var node = document.querySelector('.editor-post-save-draft');

    if (!node) {
      node = document.querySelector('.editor-post-switch-to-draft');
    }

    if (node) {
      if (statusLabel) {
        if('draft' == status && -1 !== PPCustomStatuses.publishedStatuses.indexOf(wp.data.select('core/editor').getCurrentPostAttribute('status'))) {
          document.querySelector('.editor-post-save-draft, .editor-post-switch-to-draft').innerText = __('Switch to Draft');
        } else {
          document.querySelector('.editor-post-save-draft, .editor-post-switch-to-draft').innerText = "".concat(__('Save as'), " ").concat(statusLabel);
        }
        node.dataset.ppInnerTextUpdated = true;
      }
    }
  }, 100);
};

/**
 * Hack :(
 * We need an interval because the DOM element is removed by autosave and rendered back after finishing.
 *
 * @see https://github.com/WordPress/gutenberg/issues/3144
 */
setInterval(function () {
  var status = wp.data.select('core/editor').getEditedPostAttribute('status');

  if ('future' == status ) {
    return;
  }
    
  jQuery(document).ready(function ($) {
    if (! $('div.publishpress-extended-post-status:visible').length) {
      return;
    }
  });

  if (-1 !== PPCustomStatuses.publishedStatuses.indexOf(status)) {
    return;
  }

  sideEffectL10nManipulation(status);
}, 250);

/**
 * Custom status component
 * @param object props
 */
var PPCustomPostStatusInfo = function PPCustomPostStatusInfo(_ref) {
  var onUpdate = _ref.onUpdate,
      status = _ref.status;

  var storedStatus = wp.data.select('core/editor').getCurrentPostAttribute('status');
  
  var statusOptions = statuses.slice();

  var getStatusOptionLabel = function getStatusOptionLabel(slug) {
    var item = statusOptions.find(function (s) {
      return s.value === slug;
    });

    if (item) {
      return item.label;
    }
  
    return '';
  };

  if (!getStatusOptionLabel(storedStatus) && -1 !== PPCustomStatuses.publishedStatuses.indexOf(storedStatus)) {
    var currentStatus = {label:__('(Published)'), value: storedStatus};
    statusOptions.unshift(currentStatus);
  }

  return React.createElement(PluginPostStatusInfo, {
    className: "publishpress-extended-post-status publishpress-extended-post-status-".concat(status)
  }, React.createElement("h4", null, __('Post Status', 'publishpress')), -1 == PPCustomStatuses.publishedStatuses.indexOf(status) && (-1 == PPCustomStatuses.publishedStatuses.indexOf(storedStatus) || $('div.publishpress-extended-post-status').hasClass('pp-saving-draft')) ? React.createElement(SelectControl, {
    label: "",
    value: status,
    options: statusOptions,
    onChange: onUpdate
  }) : React.createElement("div", null, __('Published', 'publishpress')), React.createElement("small", {
    className: "publishpress-extended-post-status-note"
  }, -1 == PPCustomStatuses.publishedStatuses.indexOf(status) ? __("This will override all status settings above.", 'publishpress') : __('To select a workflow status, switch to Draft first.', 'publishpress')) );
};

var plugin = compose(withSelect(function (select) {
  return {
    status: select('core/editor').getEditedPostAttribute('status')
  };
}), withDispatch(function (dispatch) {
  return {
    onUpdate: function onUpdate(status) {
      dispatch('core/editor').editPost({
        status: status
      });
      sideEffectL10nManipulation(status);
    }
  };
}))(PPCustomPostStatusInfo);
registerPlugin('publishpress-custom-status-block', {
  icon: 'admin-site',
  render: plugin
});